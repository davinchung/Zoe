pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
k_left  = 0
k_right = 1
k_up    = 2
k_down  = 3

map_x = 0
map_y = 32

local objects = {}

function _init()
  cls()
end

function object(x,y)
  local t = {
    x = x,
    y = y,
    width = 1,
    height = 1,
  }
  setmetatable(t,objects)
  return t
end

local zoe = object(70,74)
zoe.width = 2
zoe.face = false

function objects.__add(u,v)
  return object(
    u.x + v.x,
    u.y + v.y
  )
end

function objects.__sub(u,v)
  return object(
    u.x - v.x,
    u.y - v.y
  )
end

function move_zoe()
  -- move zoe --
  prev_x = zoe.x
  prev_y = zoe.y 

  if(btn(k_left)) then
    zoe.x -= 1
    zoe.face = false
  end
  
  if(btn(k_right)) then
    zoe.x += 1
    zoe.face = true  
  end
  
  if(btn(k_up)) then
    zoe.y -= 1
  end
  
  if(btn(k_down)) then
    zoe.y += 1
  end


  which_cell = cell_collide(zoe)
  -- If Zoe collides with a cell with flag 0 then..
  -- Assuming all barriers/objects are one cell...
  if (which_cell != false) then
      --print(which_cell.x)
      --print(which_cell.y)
    if (collide(hitbox(zoe),hitbox(which_cell))) then
      zoe.x = prev_x
      zoe.y = prev_y
    end
  end
 --[[
  local x1,x2,y1,y2

  x1 = (zoe.x-map_x)/8
  y1 = (zoe.y-map_y)/8
  x2 = (zoe.x+15-map_x)/8
  y2 = (zoe.y+7-map_y)/8
  --x3 = (zoe.y+7-map_x)/8

  local a=fget(mget(x1,y1),0)
  local b=fget(mget(x1,y2),0)
  local c=fget(mget(x2,y2),0)
  local d=fget(mget(x2,y1),0)
  local e=fget(mget(x1+1,y1),0)
  local f=fget(mget(x1+1,y2),0)


  obj_collide = a or b or c or d or e or f

  if (obj_collide) then
    zoe.x = prev_x
    zoe.y = prev_y
  end

--]]
end


function _update()
  move_zoe()
end

function _draw()
 --cls()
  -- draw map --
  map(0,0,map_x,map_y,16,8)
  
  -- draw zoe --
  spr(1,zoe.x,zoe.y,
    zoe.width,zoe.height,
    zoe.face)

  draw_hitbox(hitbox(zoe))
end

function hitbox(obj)
  temp = object(obj.x, obj.y+8*obj.height-4)
  temp.height = obj.height*1/2 -- not to be spr'ed!
  temp.width = obj.width
  return temp
end

-- if we're going to be using hitbox, we shouldn't use flags...
-- returns and object with x_pos and y_pos if obj collides with a cell with flag 0
-- returns false otherwise
function cell_collide(obj)
  --local x1,x2,y1,y2
  local celx = {}
  local cely = {}
  --local flag_cell = {}

  celx[1]=(obj.x-map_x)/8
  cely[1]=(obj.y-map_y)/8
  celx[obj.width+1]=(obj.x+obj.width*8-1-map_x)/8
  cely[obj.height+1]=(obj.y+obj.height*8-1-map_y)/8

  for i=2, obj.width do
    if celx[i]==nil then celx[i]=celx[i-1]+1 end
  end

  for i=2, obj.height do
    if cely[i]==nil then cely[i]=cely[i-1]+1 end
  end

  is_flag = false

  for i=1, count(celx) do
    for j=1, count(cely) do

      is_flag = fget(mget(celx[i],cely[j]),0)

      --flag_cell[j+count(celx)*(i-1)]=fget(mget(celx[i],cely[j]),0)
      if (is_flag) then 
        x_pos = celx[i] * 8 
        y_pos = cely[j] * 8
        cell=object(x_pos,y_pos)
        return cell
      end
    end
  end

  return false
end

-- for testing out hitbox...
function draw_hitbox(hbox)
  spr(11,hbox.x,hbox.y-4,hbox.width,1)
end


-- returns TRUE if a and b collides
-- returns FALSE otherwise
function collide(a,b)
  -- get corners
  ax1 = a.x
  ay1 = a.y
  ax2 = a.x + a.width*8
  ay2 = a.y + a.height*8
  
  bx1 = b.x
  by1 = b.y
  bx2 = b.x + b.width*8
  by2 = b.y + b.height*8
  
  -- if b is left/right of a
  if (bx2 <= ax1)
   or (ax2 <= bx1) then
    return false
  end
    
  -- if b is above/below of a
  if (by2 <= ay1)
    or (ay2 <= by1) then
      return false
  end
  
  -- otherwise they intersect
  return true
end

__gfx__
000000000900900000000090000000003d553d51dddddddddddddddd44444444000f4000ffffffff222222220000000000000000000000000000000000000000
000000000999900000000900000040005535d555dddddddddddddddd00fff50000400f00ffffffff222222220000000000000000000000000000000000000000
007007000a9a99000000009000b2b20015555535dddddddddddddddd005fff000f0000f0ffffffff222222220000000000000000000000000000000000000000
0007700009999999999900900b2b2b205351d555dddddddddddddddd00f55f0000f0004044444444222222220000000000000000000000000000000000000000
00077000000999999990990002b2b2b055d55351dddddddddddddddd00ffff0000400f0044444444222222227777777700000000000000000000000000000000
0070070000009999999000000bbb2bb0d55355d5dddddddddddddddd00f5f5000400040044444444222222227777777700000000000000000000000000000000
0000000000000900090000000bbbb2b053515553dddddddddddddddd00ff5f000000f00044444444222222227777777700000000000000000000000000000000
00000000000009000900000000bbbb0015d551d577777777dddddddd444444440000400044444444222222227777777700000000000000000000000000000000
__gff__
0001010100010001000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
060606060606060606060606060606060a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
060606060606060606060606060606060a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
060606060606060606060606060606060a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
060606060606060606060606060606060a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
050505050505050505050505050505050a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
040404040404040404040404040404040a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
040409040404040404040404040404040a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
040404040404040404040404040404040a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
