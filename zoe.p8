pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
k_left  = 0
k_right = 1
k_up    = 2
k_down  = 3

local objects = {}

function _init()
  cls()
end

function object(x,y)
  local t = {
    x = x,
    y = y,
    width = 1,
    height = 1,
  }
  setmetatable(t,objects)
  return t
end

function hitbox(obj)
  temp = object(obj.x, obj.y+8*obj.height-4)
  temp.height = obj.height*1/2 -- NOT to be spr'ed!
  temp.width = obj.width
  return temp
end

local zoe = object(70,70)
zoe.width = 2
zoe.face = false

function objects.__add(u,v)
  return object(
    u.x + v.x,
    u.y + v.y
  )
end

function objects.__sub(u,v)
  return object(
    u.x - v.x,
    u.y - v.y
  )
end

function _update()

  -- move zoe --
  prev_x = zoe.x
  prev_y = zoe.y 

  if(btn(k_left)) then
    zoe.x -= 1
    zoe.face = false
  end
  
  if(btn(k_right)) then
    zoe.x += 1
    zoe.face = true  
  end
  
  if(btn(k_up)) then
    zoe.y -= 1
  end
  
  if(btn(k_down)) then
    zoe.y += 1
  end

  --hitbox_collide(hitbox(zoe))
 
  local x1,x2,y1,y2

  x1 = zoe.x/8
  y1 = zoe.y/8
  x2 = (zoe.x+15)/8
  y2 = (zoe.y+7)/8

  local a=fget(mget(x1,y1),0)
  local b=fget(mget(x1,y2),0)
  local c=fget(mget(x2,y2),0)
  local d=fget(mget(x2,y1),0)
  local e=fget(mget(x1+1,y1),0)
  local f=fget(mget(x1+1,y2),0)


  obj_collide = a or b or c or d or e or f

  if (obj_collide) then
    zoe.x = prev_x
    zoe.y = prev_y
  end

end

function _draw()
  -- draw map --
  map(0,0,0,0,16,8)
  
  -- draw zoe --
  spr(1,zoe.x,zoe.y,
    zoe.width,zoe.height,
    zoe.face)
end

-- If we're going to be using hitbox, we shouldn't use flags...
-- NOT DONE
function hitbox_collide(obj)
  tempx = obj.x
  tempy = obj.y

  --local x1,x2,y1,y2
  local celx = {}
  local cely = {}
  local flag_cell = {}

  celx[1]=obj.x/8
  cely[1]=obj.y/8

  for i=2, obj.width+1 do
    if celx[i]==nil then celx[i]=(obj.x+(i-1)*8-1)/8 end
  end

  for i=2, obj.height+1 do
    if cely[i]==nil then cely[i]=(obj.y+(i-1)*8-1)/8 end
  end

  for i=1, count(celx) do
    for j=1, count(cely) do
      flag_cell[j+count(celx)*(i-1)]=fget(mget(celx[i],cely[j]),0)
    end
  end

  obj_collide = false

  i = 1

  for i=1, count(flag_cell) do
    if (flag_cell[i]) then obj_collide=true end
  end

  if (obj_collide) then
    obj.x = tempx
    obj.y = tempy
  end
end

function collide(a,b)
  -- get corners
  ax1 = a.x
  ay1 = a.y
  ax2 = a.x + a.width*8
  ay2 = a.y + a.height*8
  
  bx1 = b.x
  by1 = b.y
  bx2 = b.x + b.width*8
  by2 = b.y + b.height*8
  
  -- if b is left/right of a
  if (bx2 <= ax1)
   or (ax2 <= bx1) then
    return false
  end
    
  -- if b is above/below of a
  if (by2 <= ay1)
    or (ay2 <= by1) then
      return false
  end
  
  -- otherwise they intersect
  return true
end

__gfx__
000000000900900000000090000000003d553d51dddddddddddddddd44444444000f4000ffffffff000000000000000000000000000000000000000000000000
000000000999900000000900000040005535d555dddddddddddddddd00fff50000400f00ffffffff000000000000000000000000000000000000000000000000
007007000a9a99000000009000b2b20015555535dddddddddddddddd005fff000f0000f0ffffffff000000000000000000000000000000000000000000000000
0007700009999999999900900b2b2b205351d555dddddddddddddddd00f55f0000f0004044444444000000000000000000000000000000000000000000000000
00077000000999999990990002b2b2b055d55351dddddddddddddddd00ffff0000400f0044444444000000000000000000000000000000000000000000000000
0070070000009999999000000bbb2bb0d55355d5dddddddddddddddd00f5f5000400040044444444000000000000000000000000000000000000000000000000
0000000000000900090000000bbbb2b053515553dddddddddddddddd00ff5f000000f00044444444000000000000000000000000000000000000000000000000
00000000000009000900000000bbbb0015d551d577777777dddddddd444444440000400044444444000000000000000000000000000000000000000000000000
__gff__
0001010100010001000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0606060606060606060606060606060600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0606060606060606060606060606060600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0606060606060606060606060606060600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0606060606060606060606060606060600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050505050505050505050505050500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404090404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
